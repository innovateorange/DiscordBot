name: Update stage branch from main
on:
  schedule:
      - cron: "0 4 1,15 * *"
  workflow_dispatch:

jobs:
  create-pr-main-to-stage:
    runs-on: ubuntu-latest
    env:
      SOURCE_BRANCH: main
      TARGET_BRANCH: stage
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.SOURCE_BRANCH }}
          fetch-depth: 0

      - name: Create or update PR from main to stage
        run: |
          git fetch origin --prune

          # Check if a PR already exists
          EXISTING_PR=$(gh pr list --base ${TARGET_BRANCH} --head ${SOURCE_BRANCH} --json number --jq '.[0].number')

          if [ -z "$EXISTING_PR" ]; then
            # Create new PR with multi-line body
            PR_BODY="Automated update of stage branch from main branch.

          This PR is automatically created by the update-stage workflow.

          ðŸ¤– Generated with GitHub Actions"

            PR_NUMBER=$(gh pr create \
              --base ${TARGET_BRANCH} \
              --head ${SOURCE_BRANCH} \
              --title "Update stage from main" \
              --body "$PR_BODY" \
              --json number --jq '.number')

            echo "Created PR #$PR_NUMBER"
          else
            PR_NUMBER=$EXISTING_PR
            echo "PR #$PR_NUMBER already exists from ${SOURCE_BRANCH} to ${TARGET_BRANCH}"
          fi

          # Auto-merge the PR
          echo "Auto-merging PR #$PR_NUMBER"
          gh pr merge $PR_NUMBER --squash --auto || gh pr merge $PR_NUMBER --squash


    